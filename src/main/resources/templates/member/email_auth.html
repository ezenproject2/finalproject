<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <title> 이젠문고 </title>
  <meta charset="UTF-8"/>
  <link rel="stylesheet" href="/css/memberPwFind.css"/>

</head>
<main layout:fragment="main">
  <form class="content" action="/member/email_auth" method="post">
    <div class="textbox">
      <input id="text" name="name" required="" type="text" />
      <div class="error">이름을 입력하세요</div>
    </div>
    <div class="textbox">
      <input id="email" name="email" required="" type="email" />
      <div class="error">유효하지 않은 이메일주소 입니다</div>
    </div>
    <input type="submit" id="check" class="emailAuthButton" value="이메일 인증">

    <!-- 이메일 인증 모달 -->
    <div id="emailAuthModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <input type="hidden" id="hiddenEmail" name="hiddenEmail">
        <div class="textbox">
          <input type="text" id="authCode" name="authCode" placeholder="인증번호를 입력하세요"><label>인증번호 </label>
          <div class="error"> </div>
        </div><br><br>
        <span class="error_message" id="authErrorMessage"></span>
        <input type="button" id="verifyAuthCode" value="확인">
      </div>
    </div>
    <div class="content">
      <div class="message">
        <th:if test="${param.error == 'invalid_verification_code'}">
          <p style="color:red;">잘못된 인증 코드입니다. 다시 입력해 주세요.</p>
        </th:if>
        <th:if test="${param.success == 'true'}">
          <p style="color:green;">인증이 완료되었습니다!</p>
        </th:if>
      </div>
    </div>
  </form>
  <script>
    document.querySelector('.emailAuthButton').addEventListener('click', function() {
            const email = document.getElementById('email').value;

            // 이메일이 비어있는 경우
            if (!email) {
                document.querySelector('.error_message').textContent = '이메일을 입력해주세요.';
                 alert("이메일을 입력해주세요.");
                return;
            }



            // 이메일 중복 체크
            fetch('/member/check-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 이메일이 사용 가능할 경우 인증 코드 전송
                    document.getElementById('emailErrorMessage').textContent = ''; // 에러 메시지 제거
                    document.getElementById('hiddenEmail').value = email;  // 이메일을 모달에 전달

                    // 이메일 인증 모달을 보여줌
                    document.getElementById('emailAuthModal').style.display = 'block';

                    // 인증 코드 전송 API 호출
                    fetch('/member/sendEmailAuth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);  // 이메일 인증 코드가 전송되었음을 알림
                        } else {
                            alert(data.message);  // 이메일 전송 실패 시 오류 메시지
                        }
                    });
                } else {
                    // 이메일 중복 오류
                    document.getElementById('emailErrorMessage').textContent = data.message;
                }
            });
        });

        // 인증 코드 확인
        document.getElementById('verifyAuthCode').addEventListener('click', function() {
            const email = document.getElementById('hiddenEmail').value;
            const enteredCode = document.getElementById('authCode').value;

            if (!enteredCode) {
                document.getElementById('authErrorMessage').textContent = '인증번호를 입력해주세요.';
                return;
            }

            // 인증 코드 확인 API 호출
            fetch('/member/verifyEmailAuth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: enteredCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('인증이 완료되었습니다.');
                    document.getElementById('emailAuthModal').style.display = 'none';  // 모달 숨기기
                    isEmailVerified = true;
                } else {
                    document.getElementById('authErrorMessage').textContent = data.message;
                }
            });
        });

        // 모달 닫기
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('emailAuthModal').style.display = 'none';
        });
  </script>
</main>